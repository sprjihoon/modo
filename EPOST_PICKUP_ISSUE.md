# 우체국 수거예약 문제 해결 가이드

## 문제 상황
실제 우체국 API 호출에 성공하여 송장번호(`regiNo`)를 받았지만, 우체국에서 실제로 방문하지 않는 경우가 발생합니다.

## 원인 분석

### 1. 우체국 API의 실제 동작 방식
우체국 API는 `testYn='N'`으로 호출해도 **실제 수거예약이 등록되지 않을 수 있습니다**.

- **송장번호 발급**: API 호출이 성공하면 송장번호(`regiNo`)를 반환합니다.
- **실제 수거예약 등록**: 송장번호를 받았다고 해서 실제 수거예약이 등록된 것은 아닙니다.

### 2. 우체국 계약 상태
실제 수거예약이 등록되려면 **우체국과의 계약이 완료**되어야 합니다.

- 우체국 API는 개발/테스트 환경과 운영 환경이 다를 수 있습니다.
- 계약이 완료되지 않은 상태에서는 송장번호만 발급되고 실제 수거예약은 등록되지 않을 수 있습니다.

### 3. API 응답 확인
API 응답에서 실제로 수거예약이 등록되었는지 확인해야 합니다.

- `regiNo` (운송장번호): 송장번호만 발급되었는지 확인
- `resNo` (소포 예약번호): 실제 수거예약이 등록되었는지 확인
- `resDate` (예약 일시): 수거예약 일시 확인
- `regiPoNm` (접수 우체국명): 접수 우체국 확인

## 해결 방법

### 1. 우체국 고객센터 문의
가장 확실한 방법은 **우체국 고객센터(1588-1300)에 직접 문의**하는 것입니다.

- 송장번호(`regiNo`)를 제공하여 실제 수거예약이 등록되었는지 확인
- 계약 상태 확인
- 실제 수거예약 등록을 위한 추가 절차 확인

### 2. 수거예약 확인 API 호출
`getResInfo` API를 호출하여 실제 수거예약이 등록되었는지 확인할 수 있습니다.

```typescript
import { getResInfo } from '../_shared/epost/index.ts';

// 수거예약 확인
const resInfo = await getResInfo({
  custNo: custNo,
  reqType: '1', // 1:일반소포
  orderNo: order_id,
  reqYmd: epostResponse.resDate.substring(0, 8), // YYYYMMDD
});

console.log('수거예약 상태:', {
  treatStusCd: resInfo.treatStusCd, // 00:신청준비, 01:소포신청, 02:운송장출력, 03:집하완료...
  regiNo: resInfo.regiNo,
  resNo: resInfo.resNo,
});
```

### 3. 로그 확인
Supabase Edge Functions 로그에서 다음 정보를 확인하세요:

- `testYn` 값이 `'N'`으로 설정되었는지 확인
- `test_mode` 파라미터가 `false`로 전달되었는지 확인
- API 응답에서 `regiNo`, `resNo`, `resDate` 값 확인

### 4. 환경 변수 확인
다음 환경 변수가 올바르게 설정되어 있는지 확인하세요:

- `EPOST_CUSTOMER_ID`: 우체국 고객번호
- `EPOST_API_KEY`: 우체국 API 키
- `EPOST_SECURITY_KEY`: 우체국 보안키 (SEED128 암호화용)
- `EPOST_APPROVAL_NO`: 계약 승인번호 (선택사항, 없으면 자동 조회)
- `EPOST_OFFICE_SER`: 공급지 코드 (선택사항)

## 확인 사항 체크리스트

- [ ] `test_mode` 파라미터가 `false`로 전달되었는지 확인
- [ ] `testYn` 값이 `'N'`으로 설정되었는지 확인
- [ ] 우체국 API 응답에서 `regiNo` (운송장번호)를 받았는지 확인
- [ ] 우체국 API 응답에서 `resNo` (소포 예약번호)를 받았는지 확인
- [ ] 우체국 API 응답에서 `resDate` (예약 일시)를 받았는지 확인
- [ ] 우체국 고객센터(1588-1300)에 송장번호로 문의하여 실제 수거예약이 등록되었는지 확인
- [ ] 우체국과의 계약 상태 확인
- [ ] `getResInfo` API를 호출하여 수거예약 상태 확인 (`treatStusCd` 확인)

## 참고 사항

- 우체국 API는 개발/테스트 환경과 운영 환경이 다를 수 있습니다.
- 계약이 완료되지 않은 상태에서는 송장번호만 발급되고 실제 수거예약은 등록되지 않을 수 있습니다.
- 실제 수거예약이 등록되려면 우체국과의 계약이 완료되어야 합니다.

