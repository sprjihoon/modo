# 카카오 알림톡 연동 가이드

모두의 수선 앱에서 카카오 알림톡을 연동하는 방법을 설명합니다.

## 📋 목차

1. [카카오 비즈니스 채널 설정](#1-카카오-비즈니스-채널-설정)
2. [알림톡 템플릿 등록](#2-알림톡-템플릿-등록)
3. [환경변수 설정](#3-환경변수-설정)
4. [데이터베이스 마이그레이션](#4-데이터베이스-마이그레이션)
5. [테스트](#5-테스트)
6. [알림 유형별 템플릿](#6-알림-유형별-템플릿)

---

## 1. 카카오 비즈니스 채널 설정

### 1.1 채널 공개 설정 (현재 단계)
스크린샷에 보이는 화면에서:
1. **"공개 설정하기"** 버튼 클릭
2. 채널이 공개되면 카카오톡 사용자가 검색/방문 가능

### 1.2 알림톡 발송 권한 신청
1. 좌측 메뉴에서 **"메시지"** 클릭
2. **"알림톡"** 선택
3. 발송 권한 신청 (사업자등록증 필요)
4. 심사 완료 대기 (보통 1-3일)

### 1.3 발신 프로필 키 확인
1. **채널** 메뉴 → **채널 관리**
2. **발신 프로필** 탭
3. **발신 프로필 키(Sender Key)** 복사해두기

---

## 2. 알림톡 템플릿 등록

카카오 비즈메시지 센터에서 각 알림 유형별 템플릿을 등록하고 승인받아야 합니다.

### 2.1 템플릿 등록 방법
1. **메시지** → **알림톡** → **템플릿 관리**
2. **새 템플릿 등록** 클릭
3. 아래 내용 입력:
   - 템플릿 코드 (예: `MODO_ORDER_PAID`)
   - 템플릿 이름
   - 메시지 내용 (변수 포함)
4. **검수 요청** 클릭
5. 승인 대기 (보통 1-2 영업일)

### 2.2 등록해야 할 템플릿 목록 (총 9개)

| 순서 | 템플릿 코드 | 용도 | 변수 |
|------|------------|------|------|
| 1 | `MODO_ORDER_PAID` | 결제 완료 | 고객명, 주문번호, 결제금액 |
| 2 | `MODO_ORDER_BOOKED` | 수거 예약 완료 | 고객명, 주문번호, 수거일 |
| 3 | `MODO_ORDER_INBOUND` | 입고 완료 | 고객명, 주문번호 |
| 4 | `MODO_ORDER_PROCESSING` | 수선 시작 | 고객명, 주문번호 |
| 5 | `MODO_ORDER_READY` | 출고 완료 | 고객명, 주문번호, 송장번호 |
| 6 | `MODO_ORDER_DELIVERED` | 배송 완료 | 고객명, 주문번호 |
| 7 | `MODO_EXTRA_CHARGE` | 추가 결제 요청 | 고객명, 주문번호, 추가금액 |
| 8 | `MODO_PICKUP_D1` | 수거 D-1 알림 | 고객명, 수거일 |
| 9 | `MODO_PICKUP_TODAY` | 수거 당일 알림 | 고객명 |

### 2.3 템플릿 내용 예시 (복사해서 사용)

#### 1. 결제 완료 (MODO_ORDER_PAID)
```
[모두의 수선] 결제 완료

#{고객명}님, 주문이 완료되었습니다.

■ 주문번호: #{주문번호}
■ 결제금액: #{결제금액}원

수거 예약 후 택배 기사님이 방문합니다.
감사합니다!
```

#### 2. 수거 예약 완료 (MODO_ORDER_BOOKED)
```
[모두의 수선] 수거 예약 완료

#{고객명}님, 수거 예약이 완료되었습니다.

■ 주문번호: #{주문번호}
■ 수거예정일: #{수거일}

택배 기사님이 방문 예정입니다.
의류를 문 앞에 준비해 주세요!
```

#### 3. 입고 완료 (MODO_ORDER_INBOUND)
```
[모두의 수선] 입고 완료

#{고객명}님의 의류가 입고되었습니다.

■ 주문번호: #{주문번호}

곧 수선 작업을 시작합니다.
완료되면 다시 안내드릴게요!
```

#### 4. 수선 시작 (MODO_ORDER_PROCESSING)
```
[모두의 수선] 수선 시작

#{고객명}님의 의류 수선을 시작합니다.

■ 주문번호: #{주문번호}

정성껏 수선하여 보내드릴게요!
```

#### 5. 출고 완료 (MODO_ORDER_READY)
```
[모두의 수선] 출고 완료

#{고객명}님의 수선이 완료되어 출고되었습니다!

■ 주문번호: #{주문번호}
■ 송장번호: #{송장번호}

빠른 시일 내에 받아보실 수 있습니다.
```

#### 6. 배송 완료 (MODO_ORDER_DELIVERED)
```
[모두의 수선] 배송 완료

#{고객명}님, 배송이 완료되었습니다!

■ 주문번호: #{주문번호}

이용해 주셔서 감사합니다.
만족스러우셨다면 리뷰 부탁드려요!
```

#### 7. 추가 결제 요청 (MODO_EXTRA_CHARGE)
```
[모두의 수선] 추가 결제 안내

#{고객명}님, 의류 검수 중 추가 작업이 필요합니다.

■ 주문번호: #{주문번호}
■ 추가금액: #{추가금액}원

앱에서 확인 후 진행 여부를 선택해 주세요.
```

#### 8. 수거 D-1 알림 (MODO_PICKUP_D1)
```
[모두의 수선] 내일 수거 예정

#{고객명}님, 내일 의류 수거가 예정되어 있습니다.

■ 수거예정일: #{수거일}

의류를 문 앞에 준비해 주세요!
```

#### 9. 수거 당일 알림 (MODO_PICKUP_TODAY)
```
[모두의 수선] 오늘 수거일입니다

#{고객명}님, 오늘 택배 기사님이 방문합니다.

의류를 문 앞에 준비해 주세요!
방문 전 연락드릴 예정입니다.
```

---

## 3. 환경변수 설정

### 3.1 Supabase Edge Functions 환경변수

Supabase Dashboard → Edge Functions → Secrets에서 설정:

```bash
# 카카오 비즈메시지
KAKAO_BIZM_SENDER_KEY=발신프로필키
KAKAO_BIZM_API_KEY=API키
```

### 3.2 환경변수 설정 방법

#### Supabase CLI
```bash
supabase secrets set KAKAO_BIZM_SENDER_KEY=your_sender_key
supabase secrets set KAKAO_BIZM_API_KEY=your_api_key
```

#### Supabase Dashboard
1. Dashboard → Project Settings → Edge Functions
2. Manage secrets 클릭
3. 각 키 추가

---

## 4. 데이터베이스 마이그레이션

### 4.1 마이그레이션 실행

Supabase SQL Editor에서 순서대로 실행:

```sql
-- 1. 알림톡 테이블 생성
-- sql/migrations/create_kakao_alimtalk_tables.sql 내용 실행

-- 2. notifications 테이블 컬럼 추가
-- sql/migrations/add_alimtalk_columns_to_notifications.sql 내용 실행
```

---

## 5. 테스트

### 5.1 테스트 발송
템플릿 승인 후 카카오 비즈메시지 센터에서 테스트 발송 가능

---

## 6. 연동되는 알림 목록

| 알림 유형 | FCM | 알림톡 | 트리거 |
|----------|-----|-------|--------|
| 결제 완료 | ✅ | ✅ | 주문 상태 → PAID |
| 수거 예약 완료 | ✅ | ✅ | 주문 상태 → BOOKED |
| 입고 완료 | ✅ | ✅ | 주문 상태 → INBOUND |
| 수선 시작 | ✅ | ✅ | 주문 상태 → PROCESSING |
| 출고 완료 | ✅ | ✅ | 주문 상태 → READY_TO_SHIP |
| 배송 완료 | ✅ | ✅ | 주문 상태 → DELIVERED |
| 추가 결제 요청 | ✅ | ✅ | 추가결제 상태 → PENDING_CUSTOMER |
| 수거 D-1 알림 | ✅ | ✅ | Cron (매일 9시) |
| 수거 당일 알림 | ✅ | ✅ | Cron (매일 9시) |

---

## 📝 체크리스트

- [ ] 채널 공개 설정 완료
- [ ] 알림톡 발송 권한 승인 완료
- [ ] 발신 프로필 키 확보
- [ ] 템플릿 등록 및 승인 (9개)
- [ ] 환경변수 설정
- [ ] DB 마이그레이션 실행
- [ ] Edge Function 업데이트
- [ ] 테스트 발송 확인

