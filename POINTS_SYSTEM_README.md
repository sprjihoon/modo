# ν¬μΈνΈ κ΄€λ¦¬ μ‹μ¤ν… κµ¬ν„

ν¬μΈνΈ κ΄€λ¦¬ μ‹μ¤ν…μ΄ μ„±κ³µμ μΌλ΅ κµ¬ν„λμ—μµλ‹λ‹¤. μ΄ λ¬Έμ„λ” κµ¬ν„λ κΈ°λ¥κ³Ό μ‚¬μ© λ°©λ²•μ„ μ„¤λ…ν•©λ‹λ‹¤.

## π“‹ κµ¬ν„λ κΈ°λ¥

### 1. λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§
- **ν¬μΈνΈ κ±°λ λ‚΄μ—­ ν…μ΄λΈ”** (`point_transactions`)
  - ν¬μΈνΈ μ λ¦½, μ‚¬μ©, κ΄€λ¦¬μ μ§€κΈ‰/μ°¨κ°, λ§λ£ λ‚΄μ—­ κ΄€λ¦¬
  - μ£Όλ¬Έ μ—°κ²° λ° κ΄€λ¦¬μ μ¶”μ 
  
- **ν¬μΈνΈ μ„¤μ • ν…μ΄λΈ”** (`point_settings`)
  - κΈ°κ°„λ³„ μ λ¦½λ¥  μ„¤μ •
  - μ°μ„ μμ„ λ° κΈ°λ³Έ μ„¤μ • κ΄€λ¦¬
  - ν™μ„±ν™”/λΉ„ν™μ„±ν™” κΈ°λ¥

- **μ‚¬μ©μ ν…μ΄λΈ” ν™•μ¥** (`users`)
  - `point_balance`: ν„μ¬ ν¬μΈνΈ μ”μ•΅
  - `total_earned_points`: μ΄ μ λ¦½ ν¬μΈνΈ
  - `total_used_points`: μ΄ μ‚¬μ© ν¬μΈνΈ

### 2. μλ™ ν¬μΈνΈ μ λ¦½
- μ£Όλ¬Έ μƒνƒκ°€ `DELIVERED`(λ°°μ†΅ μ™„λ£)λ΅ λ³€κ²½λλ©΄ μλ™μΌλ΅ ν¬μΈνΈ μ λ¦½
- ν„μ¬ ν™μ„±ν™”λ ν¬μΈνΈ μ„¤μ •μ μ λ¦½λ¥  μλ™ μ μ©
- μ λ¦½λ ν¬μΈνΈλ” 1λ…„ ν›„ λ§λ£

### 3. κ΄€λ¦¬μ κΈ°λ¥

#### κ³ κ° μƒμ„Έ νμ΄μ§€ (`/dashboard/customers/[id]`)
- **ν¬μΈνΈ μ •λ³΄ ν‘μ‹**
  - ν„μ¬ ν¬μΈνΈ μ”μ•΅
  - μ΄ μ λ¦½ ν¬μΈνΈ
  - μ΄ μ‚¬μ© ν¬μΈνΈ

- **ν¬μΈνΈ μ§€κΈ‰/μ°¨κ° κΈ°λ¥**
  - ν¬μΈνΈ μ§€κΈ‰ (ADMIN_ADD)
  - ν¬μΈνΈ μ°¨κ° (ADMIN_SUB)
  - μ‚¬μ  μ…λ ¥ ν•„μ
  - μ”μ•΅ λ¶€μ΅± μ‹ μ°¨κ° λ¶κ°€

#### ν¬μΈνΈ μ„¤μ • κ΄€λ¦¬ νμ΄μ§€ (`/dashboard/settings/points`)
- **ν¬μΈνΈ μ λ¦½λ¥  μ„¤μ •**
  - μ„¤μ •λ…, μ„¤λ…, μ λ¦½λ¥ (%) μ…λ ¥
  - μ‹μ‘μΌ, μΆ…λ£μΌ μ„¤μ • (λ¬΄κΈ°ν• κ°€λ¥)
  - μ°μ„ μμ„ μ„¤μ •
  - ν™μ„±ν™”/λΉ„ν™μ„±ν™” ν† κΈ€

- **ν„μ¬ μ μ© μ¤‘μΈ μ„¤μ • ν‘μ‹**
  - μ‹¤μ‹κ°„μΌλ΅ ν„μ¬ μ μ© μ¤‘μΈ μ λ¦½λ¥  ν™•μΈ

### 4. API μ—”λ“ν¬μΈνΈ

#### ν¬μΈνΈ μ§€κΈ‰/μ°¨κ°
- `POST /api/customers/[id]/points` - ν¬μΈνΈ μ§€κΈ‰/μ°¨κ°
- `GET /api/customers/[id]/points` - ν¬μΈνΈ κ±°λ λ‚΄μ—­ μ΅°ν

#### ν¬μΈνΈ μ„¤μ • κ΄€λ¦¬
- `GET /api/points/settings` - ν¬μΈνΈ μ„¤μ • λ©λ΅ μ΅°ν
- `POST /api/points/settings` - ν¬μΈνΈ μ„¤μ • μƒμ„±
- `PATCH /api/points/settings/[id]` - ν¬μΈνΈ μ„¤μ • μμ •
- `DELETE /api/points/settings/[id]` - ν¬μΈνΈ μ„¤μ • μ‚­μ 

## π€ μ„¤μΉ λ° μ‹¤ν–‰ λ°©λ²•

### 1. λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§ μ μ©

```bash
# Supabase CLIλ¥Ό μ‚¬μ©ν•λ” κ²½μ°
supabase migration new add_points_system
# κ·Έλ¦¬κ³  apps/sql/schema/16_points.sql λ‚΄μ©μ„ λ³µμ‚¬

# λλ” Supabase λ€μ‹λ³΄λ“μ—μ„ μ§μ ‘ μ‹¤ν–‰
# 1. Supabase λ€μ‹λ³΄λ“ μ ‘μ†
# 2. SQL Editorλ΅ μ΄λ™
# 3. apps/sql/schema/16_points.sql νμΌμ λ‚΄μ©μ„ λ³µμ‚¬ν•μ—¬ μ‹¤ν–‰
```

### 2. ν™κ²½ λ³€μ ν™•μΈ

`.env.local` νμΌμ— λ‹¤μ ν™κ²½ λ³€μκ°€ μ„¤μ •λμ–΄ μλ”μ§€ ν™•μΈ:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 3. μ•± μ‹¤ν–‰

```bash
cd apps/admin
npm install
npm run dev
```

## π“– μ‚¬μ© λ°©λ²•

### ν¬μΈνΈ μ λ¦½λ¥  μ„¤μ •

1. κ΄€λ¦¬μ νμ΄μ§€ μ ‘μ†: `/dashboard/settings`
2. "ν¬μΈνΈ μ λ¦½λ¥  μ„¤μ •" μΉ΄λ“μ—μ„ "μ„¤μ • κ΄€λ¦¬" ν΄λ¦­
3. "μƒ μ„¤μ • μ¶”κ°€" λ²„νΌ ν΄λ¦­
4. μ„¤μ • μ •λ³΄ μ…λ ¥:
   - **μ„¤μ •λ…**: μ) "κΈ°λ³Έ μ λ¦½λ¥ ", "κ²¨μΈ μ‹μ¦ νΉλ³„ μ λ¦½"
   - **μ„¤λ…**: μ„¤μ •μ— λ€ν• μ„¤λ…
   - **μ λ¦½λ¥ **: 0 ~ 100% (μ: 5% = 10,000μ› κ²°μ  μ‹ 500P μ λ¦½)
   - **μ‹μ‘μΌ**: μ λ¦½λ¥  μ μ© μ‹μ‘μΌ
   - **μΆ…λ£μΌ**: μ λ¦½λ¥  μ μ© μΆ…λ£μΌ (λΉ„μ›λ‘λ©΄ λ¬΄κΈ°ν•)
   - **μ°μ„ μμ„**: κ°™μ€ λ‚ μ§μ— μ—¬λ¬ μ„¤μ •μ΄ μμ„ λ• λ†’μ€ μ«μκ°€ μ°μ„ 
   - **ν™μ„±ν™”**: μ²΄ν¬ν•λ©΄ μ¦‰μ‹ μ μ©
   - **κΈ°λ³Έ μ„¤μ •**: μ²΄ν¬ν•λ©΄ κΈ°λ³Έ μ λ¦½λ¥ λ΅ μ„¤μ •

### κ³ κ°μ—κ² ν¬μΈνΈ μ§€κΈ‰/μ°¨κ°

1. κ³ κ° λ©λ΅ νμ΄μ§€ μ ‘μ†: `/dashboard/customers`
2. κ³ κ° μ„ νƒν•μ—¬ μƒμ„Έ νμ΄μ§€ μ΄λ™
3. "ν¬μΈνΈ κ΄€λ¦¬" μΉ΄λ“μ—μ„ "ν¬μΈνΈ μ§€κΈ‰/μ°¨κ°" λ²„νΌ ν΄λ¦­
4. λ‹¤μ΄μ–Όλ΅κ·Έμ—μ„:
   - **μ ν• μ„ νƒ**: ν¬μΈνΈ μ§€κΈ‰ λλ” μ°¨κ°
   - **κΈμ•΅ μ…λ ¥**: μ§€κΈ‰/μ°¨κ°ν•  ν¬μΈνΈ κΈμ•΅
   - **μ‚¬μ  μ…λ ¥**: ν¬μΈνΈ μ§€κΈ‰/μ°¨κ° μ‚¬μ  (ν•„μ)
5. ν™•μΈ λ²„νΌ ν΄λ¦­

### μλ™ ν¬μΈνΈ μ λ¦½ ν™•μΈ

1. μ£Όλ¬Έμ΄ λ°°μ†΅ μ™„λ£(`DELIVERED`) μƒνƒλ΅ λ³€κ²½λλ©΄ μλ™ μ λ¦½
2. μ λ¦½λ¥ μ€ ν„μ¬ ν™μ„±ν™”λ ν¬μΈνΈ μ„¤μ • κΈ°μ¤€
3. κ³ κ° μƒμ„Έ νμ΄μ§€μ—μ„ ν¬μΈνΈ μ”μ•΅ λ° λ‚΄μ—­ ν™•μΈ κ°€λ¥

## π― μ£Όμ” νΉμ§•

### 1. κΈ°κ°„λ³„ μ λ¦½λ¥  κ΄€λ¦¬
- νΉμ • κΈ°κ°„ λ™μ• λ‹¤λ¥Έ μ λ¦½λ¥  μ μ© κ°€λ¥
- μ: μ—°λ§ μ‹μ¦μ—λ” 10%, ν‰μ†μ—λ” 5%
- μ°μ„ μμ„ μ‹μ¤ν…μΌλ΅ μ—¬λ¬ μ„¤μ • μ¶©λ λ°©μ§€

### 2. μλ™ μ λ¦½
- μ£Όλ¬Έ μ™„λ£ μ‹ μλ™μΌλ΅ ν¬μΈνΈ μ λ¦½
- λ°μ΄ν„°λ² μ΄μ¤ νΈλ¦¬κ±°λ΅ κµ¬ν„λμ–΄ μ•μ •μ 
- μ λ¦½ ν¬μΈνΈλ” κ²°μ  κΈμ•΅μ x% (μ†μμ  μ΄ν• λ²„λ¦Ό)

### 3. κ΄€λ¦¬μ ν†µμ 
- κ³ κ°λ³„ ν¬μΈνΈ μ§μ ‘ μ§€κΈ‰/μ°¨κ° κ°€λ¥
- λ¨λ“  κ±°λλ” μ‚¬μ μ™€ ν•¨κ» κΈ°λ΅
- μ”μ•΅ λ¶€μ΅± μ‹ μ°¨κ° λ¶κ°€λ΅ μ•μ „μ„± λ³΄μ¥

### 4. ν¬μΈνΈ λ§λ£
- μ λ¦½λ ν¬μΈνΈλ” 1λ…„ ν›„ μλ™ λ§λ£
- λ§λ£ μ‹μ¤ν…μ€ λ°μ΄ν„°λ² μ΄μ¤ λ λ²¨μ—μ„ κ΄€λ¦¬

## π“ λ°μ΄ν„°λ² μ΄μ¤ ν•¨μ

### `manage_user_points()`
ν¬μΈνΈ μ§€κΈ‰/μ°¨κ°μ„ μ²λ¦¬ν•λ” λ©”μΈ ν•¨μ

```sql
SELECT manage_user_points(
  p_user_id := 'user-uuid',
  p_amount := 1000,
  p_type := 'EARNED'::point_transaction_type,
  p_description := 'μ£Όλ¬Έ μ™„λ£ μ λ¦½',
  p_order_id := 'order-uuid',
  p_admin_user_id := NULL,
  p_expires_at := NOW() + INTERVAL '1 year'
);
```

### `get_current_point_setting()`
ν„μ¬ μ μ© κ°€λ¥ν• ν¬μΈνΈ μ„¤μ • μ΅°ν

```sql
SELECT * FROM get_current_point_setting();
```

## π”’ λ³΄μ•

- RLS (Row Level Security) μ •μ±… μ μ©
- κ΄€λ¦¬μλ§ ν¬μΈνΈ μ„¤μ • κ΄€λ¦¬ κ°€λ¥
- μ‚¬μ©μλ” μμ‹ μ ν¬μΈνΈ λ‚΄μ—­λ§ μ΅°ν κ°€λ¥
- μ„λΉ„μ¤ μ—­ν•  ν‚¤λ¥Ό μ‚¬μ©ν• μ•μ „ν• API νΈμ¶

## π› λ¬Έμ  ν•΄κ²°

### ν¬μΈνΈκ°€ μλ™ μ λ¦½λμ§€ μ•λ” κ²½μ°
1. μ£Όλ¬Έ μƒνƒκ°€ `DELIVERED`μΈμ§€ ν™•μΈ
2. ν„μ¬ λ‚ μ§μ— ν™μ„±ν™”λ ν¬μΈνΈ μ„¤μ •μ΄ μλ”μ§€ ν™•μΈ
3. λ°μ΄ν„°λ² μ΄μ¤ νΈλ¦¬κ±°κ°€ ν™μ„±ν™”λμ–΄ μλ”μ§€ ν™•μΈ:
   ```sql
   SELECT * FROM pg_trigger WHERE tgname = 'trigger_auto_earn_points';
   ```

### ν¬μΈνΈ μ„¤μ •μ΄ μ μ©λμ§€ μ•λ” κ²½μ°
1. μ„¤μ •μ΄ "ν™μ„±ν™”" μƒνƒμΈμ§€ ν™•μΈ
2. μ‹μ‘μΌμ΄ ν„μ¬ λ‚ μ§ μ΄μ „μΈμ§€ ν™•μΈ
3. μΆ…λ£μΌμ΄ μ„¤μ •λμ–΄ μλ‹¤λ©΄ ν„μ¬ λ‚ μ§ μ΄ν›„μΈμ§€ ν™•μΈ
4. μ—¬λ¬ μ„¤μ •μ΄ μλ‹¤λ©΄ μ°μ„ μμ„ ν™•μΈ

## π“ ν–¥ν›„ κ°μ„  μ‚¬ν•­

- [ ] ν¬μΈνΈ μ‚¬μ© κΈ°λ¥ (κ²°μ  μ‹ ν¬μΈνΈ μ°¨κ°)
- [ ] ν¬μΈνΈ λ‚΄μ—­ μƒμ„Έ μ΅°ν νμ΄μ§€
- [ ] ν¬μΈνΈ ν†µκ³„ λ€μ‹λ³΄λ“
- [ ] ν¬μΈνΈ λ§λ£ μ•λ¦Ό κΈ°λ¥
- [ ] λ¨λ°”μΌ μ•± ν¬μΈνΈ ν‘μ‹

## π“ μ§€μ›

λ¬Έμ κ°€ λ°μƒν•κ±°λ‚ μ§λ¬Έμ΄ μμΌμ‹λ©΄ κ°λ°ν€μ— λ¬Έμν•΄μ£Όμ„Έμ”.

---

**μ‘μ„±μΌ**: 2024-12-08
**λ²„μ „**: 1.0.0

